@startuml claude-sandbox-architecture

skinparam packageStyle rectangle
skinparam componentStyle rectangle

skinparam package<<client>> {
  BackgroundColor #FFFACD
}
skinparam package<<local>> {
  BackgroundColor #E0FFE0
}
skinparam package<<remote>> {
  BackgroundColor #E0F0FF
}
skinparam package<<image>> {
  BackgroundColor #FFE0E0
}
skinparam package<<runtime>> {
  BackgroundColor #FFE5CC
}
skinparam package<<config>> {
  BackgroundColor #F0F0F0
}

title Claude Sandbox - Architecture Overview

' ========================
' LAYER 1: CLIENT / CLI
' ========================
package "CLIENT LAYER" <<client>> {
    [claude-sandbox CLI] as cli
    [detect-services.sh] as detect
    [Auto-Detection] as autodetect

    note right of cli
        Commands: local, remote,
        build, push, logs, clean
    end note
}

' ========================
' LAYER 2: ORCHESTRATION - LOCAL
' ========================
package "LOCAL EXECUTION" <<local>> {
    node "Docker Compose" {
        [docker-compose.yml] as dcyml
        note right of dcyml
            Profiles: claude,
            with-postgres, with-redis,
            with-mysql, with-sqlite
        end note
    }

    node "Docker Network" {
        [claude container] as localclaude
        database "postgres" as localpg
        database "redis" as localredis
    }
}

' ========================
' LAYER 2: ORCHESTRATION - REMOTE
' ========================
package "REMOTE EXECUTION" <<remote>> {
    node "Kubernetes Cluster" {
        [generate_k8s_job_yaml()] as jobgen
        cloud "kubectl API" as kubectl

        node "Pod" {
            [claude container] as remoteclaude
            database "postgres\n[CONDITIONAL]" as remotepg
            database "redis\n[CONDITIONAL]" as remoteredis
        }
    }
}

' ========================
' LAYER 3: CONTAINER IMAGE
' ========================
package "CONTAINER IMAGE" <<image>> {
    [Dockerfile] as dockerfile
    [Baked: ~/.claude/] as baked

    note right of dockerfile
        Base: ubuntu:24.04
        Ruby: 3.2.6 / 3.3.6 / 3.4.7
        Node: 22 LTS
        Tools: postgresql-client,
        redis-tools, chromium,
        beads, Claude CLI, SOPS
    end note
}

' ========================
' LAYER 4: RUNTIME
' ========================
package "CONTAINER RUNTIME" <<runtime>> {
    [entrypoint.sh] as entrypoint
    [safe-git] as safegit
    [Claude Code CLI] as claudecli
    [notify-telegram.sh] as telegram
    storage "/workspace" as workspace

    note right of entrypoint
        1. Clone repo
        2. Load env & decrypt secrets
        3. Detect services
        4. Wait for readiness
        5. Install dependencies
        6. Rails db:prepare
        7. Beads setup
        8. Execute Claude
        9. Telegram notification
    end note
}

' ========================
' LAYER 5: CONFIGURATION
' ========================
package "CONFIGURATION" <<config>> {
    file ".env.claude-sandbox" as envplain
    file ".env.sops" as envsops
    cloud "K8s Secrets" as k8ssecrets
    file "ruby-versions.yaml" as rubyversions
}

' ========================
' EXTERNAL SERVICES
' ========================
cloud "GitHub" as github
cloud "Telegram" as telegramapi
cloud "Docker Registry" as registry

' ========================
' RELATIONSHIPS - CLIENT TO ORCHESTRATION
' ========================
cli --> autodetect
cli --> detect
cli --> rubyversions

autodetect ..> github : git remote

' LOCAL PATH
cli --> dcyml : docker compose run
dcyml --> localclaude : creates
dcyml --> localpg : creates (conditional)
dcyml --> localredis : creates (conditional)

' REMOTE PATH
cli --> jobgen : generates YAML
cli --> kubectl : kubectl apply
jobgen --> kubectl
kubectl --> remoteclaude : creates Pod
kubectl --> remotepg : creates (conditional)
kubectl --> remoteredis : creates (conditional)
kubectl ..> k8ssecrets : injects

' ========================
' RELATIONSHIPS - IMAGE BUILDING
' ========================
cli --> dockerfile : docker build
cli --> baked : copies ~/.claude
dockerfile --> registry : docker push

' ========================
' RELATIONSHIPS - CONTAINER RUNTIME
' ========================
localclaude --> entrypoint : ENTRYPOINT
remoteclaude --> entrypoint : ENTRYPOINT

entrypoint --> github : git clone
entrypoint --> workspace : writes to
entrypoint --> envplain : sources
entrypoint --> envsops : decrypts
entrypoint --> safegit : configures
entrypoint --> claudecli : exec
entrypoint --> telegram : EXIT trap

claudecli --> workspace : reads/writes
claudecli --> safegit : git ops
safegit --> github : safe push/pull

telegram ..> telegramapi : HTTP POST

' ========================
' RELATIONSHIPS - SERVICES
' ========================
localclaude --> localpg : DATABASE_URL
localclaude --> localredis : REDIS_URL
remoteclaude --> remotepg : localhost:5432
remoteclaude --> remoteredis : localhost:6379

' ========================
' LEGEND
' ========================
legend right
    |= Color |= Layer |
    | <back:#FFFACD>   </back> | Client / CLI |
    | <back:#E0FFE0>   </back> | Local Execution |
    | <back:#E0F0FF>   </back> | Remote Execution |
    | <back:#FFE0E0>   </back> | Container Image |
    | <back:#FFE5CC>   </back> | Container Runtime |
    | <back:#F0F0F0>   </back> | Configuration |

    **Execution Paths:**
    1. Local: CLI → Docker Compose → Container
    2. Remote: CLI → kubectl → Kubernetes Pod

    **Key Features:**
    • Conditional service sidecars
    • Multiple Ruby version support
    • Encrypted secrets (SOPS)
    • Git safety wrapper
    • Telegram notifications
endlegend

@enduml

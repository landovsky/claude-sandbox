# Claude Sandbox - Kubernetes Job Template (REFERENCE ONLY)
#
# NOTE: As of Phase 3, cmd_remote() generates YAML dynamically with conditional sidecars
# instead of using this static template. This file is kept as a reference for the full
# job structure with all sidecars included.
#
# The dynamic generation conditionally includes postgres-sidecar and redis-sidecar
# based on service detection, reducing resource waste for jobs that don't need them.
#
# Prerequisites:
#   1. Create the secrets:
#      kubectl create secret generic claude-sandbox-secrets \
#        --from-literal=GITHUB_TOKEN=xxx \
#        --from-literal=ANTHROPIC_API_KEY=xxx \
#        --from-literal=TELEGRAM_BOT_TOKEN=xxx \
#        --from-literal=TELEGRAM_CHAT_ID=xxx \
#        --from-literal=REPO_URL=https://github.com/you/repo.git
#
#   2. Build and push the image:
#      docker build -t your-registry/claude-sandbox:latest docker/claude-sandbox/
#      docker push your-registry/claude-sandbox:latest
#
# Usage:
#   export TASK="work on task 123"
#   export JOB_NAME="claude-task-123"
#   envsubst < k8s/job-template.yaml | kubectl apply -f -

apiVersion: batch/v1
kind: Job
metadata:
  name: ${JOB_NAME}
  labels:
    app: claude-sandbox
    managed-by: claude-sandbox-cli
spec:
  # Auto-cleanup after 1 hour
  ttlSecondsAfterFinished: 3600
  # Don't retry on failure
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: claude-sandbox
    spec:
      restartPolicy: Never

      # Shared memory for Chrome
      volumes:
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 2Gi
      - name: workspace
        emptyDir: {}
      - name: age-key
        secret:
          secretName: age-key
          optional: true

      containers:
      - name: claude
        image: ${CLAUDE_IMAGE}
        env:
        - name: SANDBOX_MODE
          value: "${SANDBOX_MODE}"
        - name: TASK
          value: "${TASK}"
        - name: REPO_URL
          value: "${REPO_URL}"
        - name: REPO_BRANCH
          value: "${REPO_BRANCH}"
        - name: DATABASE_URL
          value: "postgis://claude:claude@localhost:5432/sandbox_development"
        - name: REDIS_URL
          value: "redis://localhost:6379"
        - name: RAILS_ENV
          value: "development"
        - name: CHROME_BIN
          value: "/usr/bin/chromium-browser"
        envFrom:
        - secretRef:
            name: claude-sandbox-secrets
        volumeMounts:
        - name: dshm
          mountPath: /dev/shm
        - name: workspace
          mountPath: /workspace
          subPath: code
        - name: age-key
          mountPath: /secrets
          readOnly: true
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
          limits:
            memory: "4Gi"
            cpu: "2"

      # Sidecar: Postgres
      - name: postgres-sidecar
        image: postgis/postgis:16-3.4-alpine
        env:
        - name: POSTGRES_USER
          value: claude
        - name: POSTGRES_PASSWORD
          value: claude
        - name: POSTGRES_DB
          value: sandbox_development
        volumeMounts:
        - name: workspace
          mountPath: /var/lib/postgresql/data
          subPath: postgres
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

      # Sidecar: Redis
      - name: redis-sidecar
        image: redis:7-alpine
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
